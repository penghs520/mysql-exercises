# 第四阶段：子查询与高级查询练习

## 练习说明
- 子查询是SQL的强大工具
- 理解子查询的执行顺序
- 掌握窗口函数的使用（MySQL 8.0+）

---

## 1. 标量子查询（返回单个值）

### 1.1 与平均值比较
```sql
-- 查询价格高于平均价格的商品
-- 显示：商品名称、价格、价格与平均价的差值
```

### 1.2 子查询在 SELECT 中
```sql
-- 查询每个订单及其占总销售额的百分比
-- 显示：订单号、订单金额、占比(%)
-- 限制前50条
```

---

## 2. 列子查询（返回一列值）

### 2.1 IN 子查询
```sql
-- 查询购买过价格超过1000元商品的用户
-- 使用子查询找出这些商品ID
-- 显示：用户ID、用户名、邮箱
```

### 2.2 NOT IN 子查询
```sql
-- 查询从未被购买过的商品
-- 显示：商品ID、商品名称、价格、库存
```

### 2.3 EXISTS 子查询
```sql
-- 查询有过评价的商品
-- 使用 EXISTS
-- 显示：商品名称、价格
-- 对比 IN 和 EXISTS 的性能（使用EXPLAIN）
```

### 2.4 NOT EXISTS 子查询
```sql
-- 查询没有评价的商品
-- 使用 NOT EXISTS
-- 显示：商品名称、销量、价格
```

---

## 3. 行子查询（返回一行）

### 3.1 多列比较
```sql
-- 查询价格和库存都等于某个商品的其他商品
-- 目标商品ID为50
-- 使用 WHERE (price, stock) = (SELECT price, stock FROM ...)
```

---

## 4. 表子查询（返回多行多列）

### 4.1 FROM 子查询（派生表）
```sql
-- 查询每个用户的消费排名
-- 先用子查询计算每个用户的消费总额
-- 再对结果进行排名
-- 显示：排名、用户名、消费总额
```

### 4.2 多层子查询
```sql
-- 查询购买了销量TOP 10商品的用户
-- 第一层：找出销量TOP 10的商品
-- 第二层：找出购买这些商品的订单
-- 第三层：找出对应的用户
-- 显示：用户名、购买的热门商品数量
```

---

## 5. 关联子查询

### 5.1 相关子查询
```sql
-- 查询每个分类下价格最高的商品
-- 使用关联子查询
-- 显示：分类名称、商品名称、价格
```

### 5.2 查询高于分类平均价的商品
```sql
-- 查询价格高于其所在分类平均价格的商品
-- 显示：分类名称、商品名称、商品价格、分类平均价
```

---

## 6. WITH (CTE) 公共表表达式

### 6.1 基础 CTE
```sql
-- 使用 CTE 计算用户消费统计
WITH user_stats AS (
  SELECT
    user_id,
    COUNT(*) as order_count,
    SUM(pay_amount) as total_amount
  FROM orders
  WHERE status = 3
  GROUP BY user_id
)
SELECT u.username, us.order_count, us.total_amount
FROM users u
JOIN user_stats us ON u.id = us.user_id
ORDER BY us.total_amount DESC
LIMIT 50;

-- 练习：改写为不使用CTE的版本，对比可读性
```

### 6.2 多个 CTE
```sql
-- 使用多个CTE分析商品销售
-- CTE1: 计算每个商品的销售数据
-- CTE2: 计算每个分类的统计
-- 最终：关联展示
WITH
product_sales AS (
  -- 商品销售统计
),
category_stats AS (
  -- 分类统计
)
SELECT ... ;
```

### 6.3 递归 CTE
```sql
-- 递归查询分类树
-- 从某个分类开始，查询所有子分类
WITH RECURSIVE category_tree AS (
  -- 锚点：顶级分类
  SELECT id, name, parent_id, 1 as level
  FROM categories
  WHERE parent_id = 0

  UNION ALL

  -- 递归：子分类
  SELECT c.id, c.name, c.parent_id, ct.level + 1
  FROM categories c
  JOIN category_tree ct ON c.parent_id = ct.id
)
SELECT * FROM category_tree;
```

---

## 7. UNION 联合查询

### 7.1 UNION 去重
```sql
-- 查询高价商品和热销商品（去重）
-- 高价：price > 1000
-- 热销：sales > 5000
-- 使用 UNION
```

### 7.2 UNION ALL 不去重
```sql
-- 统计用户的活动记录
-- 包括：下单记录、评价记录
-- 显示：用户ID、活动类型、活动时间
-- 使用 UNION ALL
-- 按时间倒序
```

---

## 8. 窗口函数（Window Functions）

### 8.1 ROW_NUMBER 行号
```sql
-- 为每个用户的订单编号
-- 按订单时间排序
-- 显示：用户名、订单号、订单时间、行号
-- 使用 ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY created_at)
```

### 8.2 RANK 排名
```sql
-- 商品价格排名（允许并列）
-- 使用 RANK() 和 DENSE_RANK() 对比
-- 显示：商品名称、价格、RANK排名、DENSE_RANK排名
```

### 8.3 累计统计
```sql
-- 计算每个用户的累计消费
-- 显示：用户ID、订单号、订单金额、累计消费
-- 使用 SUM() OVER(PARTITION BY user_id ORDER BY created_at)
-- 限制前100条
```

### 8.4 移动平均
```sql
-- 计算最近7天的订单移动平均
-- 按日期分组统计每天订单数
-- 然后计算7天移动平均
-- 使用 AVG() OVER(ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW)
```

### 8.5 LAG/LEAD 前后行数据
```sql
-- 计算订单的环比增长
-- 显示：日期、订单金额、前一天金额、增长率
-- 使用 LAG(amount, 1) OVER(ORDER BY date)
```

### 8.6 NTILE 分桶
```sql
-- 将用户按消费金额分为4个等级
-- 使用 NTILE(4)
-- 显示：用户名、消费总额、用户等级(1-4)
```

---

## 9. 条件逻辑

### 9.1 CASE 表达式
```sql
-- 为用户打标签
-- 订单数>=10: 活跃用户
-- 订单数5-9: 普通用户
-- 订单数1-4: 新用户
-- 订单数0: 未购买用户
-- 显示：用户名、订单数、用户标签
```

### 9.2 IFNULL / COALESCE
```sql
-- 查询用户信息，处理NULL值
-- 手机号为NULL显示'未填写'
-- 使用 IFNULL 或 COALESCE
```

---

## 10. 综合实战

### 10.1 销售漏斗分析
```sql
-- 分析从浏览到购买的转化
-- 显示每个阶段的用户数：
-- 1. 注册用户数
-- 2. 加购物车用户数
-- 3. 下单用户数
-- 4. 支付用户数
-- 5. 完成订单用户数
-- 计算每个阶段的转化率
```

### 10.2 商品推荐（购买关联分析）
```sql
-- 找出经常一起购买的商品组合
-- 查询同一订单中出现的商品对
-- 显示：商品1、商品2、共同出现次数
-- 条件：共同出现>=10次
-- 按次数降序
```

### 10.3 用户流失分析
```sql
-- 找出可能流失的用户
-- 定义：最后一次购买距今超过90天，且历史有过购买
-- 显示：用户ID、用户名、最后购买时间、历史订单数、历史消费额
-- 按历史消费额降序（挽回高价值用户）
```

### 10.4 ABtest 分组
```sql
-- 将用户随机分为A/B两组
-- 使用用户ID的奇偶性或MOD函数
-- 统计两组用户的订单情况
-- 显示：分组、用户数、订单数、平均订单金额
```

### 10.5 Top N per Group
```sql
-- 查询每个分类下销量最高的3个商品
-- 使用窗口函数 ROW_NUMBER()
-- 显示：分类名称、商品名称、销量、排名
```

---

## 学习检查点

完成所有练习后，你应该能够：
- [ ] 熟练使用各种类型的子查询
- [ ] 理解子查询与JOIN的区别和选择
- [ ] 掌握CTE提高SQL可读性
- [ ] 使用窗口函数进行复杂分析
- [ ] 编写递归查询处理树形结构
- [ ] 使用UNION合并结果集
- [ ] 解决复杂的数据分析问题

**下一步**: 完成后查看 `solutions/04-高级查询.md` 对照答案，然后进入第五阶段学习。
