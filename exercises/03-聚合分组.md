# 第三阶段：聚合与分组练习

## 练习说明
- GROUP BY 是数据分析的核心
- 理解聚合函数的执行顺序
- 注意 WHERE 和 HAVING 的区别

---

## 1. 基础聚合函数

### 1.1 COUNT 计数
```sql
-- 统计每个订单状态的订单数量
-- 显示：订单状态、订单数量
```

### 1.2 SUM 求和
```sql
-- 统计每个用户的消费总金额
-- 只统计已支付的订单(status>=1)
-- 显示：用户ID、用户名、消费总金额
-- 按消费金额降序
```

### 1.3 AVG 平均值
```sql
-- 统计每个分类下商品的平均价格
-- 显示：分类名称、商品数量、平均价格
-- 平均价格保留2位小数
```

### 1.4 MAX/MIN 最值
```sql
-- 统计每个用户的订单金额范围
-- 显示：用户ID、最小订单金额、最大订单金额、平均订单金额
-- 只统计有订单的用户
```

---

## 2. GROUP BY 分组

### 2.1 单字段分组
```sql
-- 按年统计注册用户数
-- 提取年份：YEAR(created_at)
-- 显示：年份、注册人数
-- 按年份排序
```

### 2.2 多字段分组
```sql
-- 按年月统计订单数和订单总金额
-- 显示：年份、月份、订单数、订单总额
-- 格式：DATE_FORMAT(created_at, '%Y-%m')
-- 按时间倒序
```

### 2.3 分组后筛选
```sql
-- 查询购买次数超过5次的用户
-- 显示：用户ID、用户名、购买次数
-- 使用 HAVING COUNT(*) > 5
```

---

## 3. HAVING 子句

### 3.1 HAVING vs WHERE
```sql
-- 统计平均价格超过500的商品分类
-- WHERE：过滤分组前的数据
-- HAVING：过滤分组后的结果
-- 显示：分类名称、商品数量、平均价格
```

### 3.2 复杂 HAVING 条件
```sql
-- 查询符合以下条件的用户：
-- 1. 订单总数 >= 3
-- 2. 消费总金额 > 1000
-- 显示：用户ID、订单数、消费总金额
```

---

## 4. GROUP_CONCAT 字符串聚合

### 4.1 合并字符串
```sql
-- 查询每个订单包含的商品名称
-- 将同一订单的商品名用逗号连接
-- 显示：订单ID、订单号、商品列表
-- 限制前20条
```

### 4.2 带分隔符和排序
```sql
-- 查询每个用户的收货地址列表
-- 格式：省-市-区
-- 使用 ' | ' 分隔多个地址
-- 显示：用户名、地址列表
-- 限制前30个用户
```

---

## 5. 分组统计实战

### 5.1 商品销售排行
```sql
-- 统计商品的销售情况
-- 显示：商品名称、总销量、销售额、订单数
-- 按销售额降序
-- 只显示有销售记录的商品
-- 限制TOP 20
```

### 5.2 用户消费分析
```sql
-- 按用户统计消费行为
-- 显示：用户名、订单总数、消费总额、平均订单金额、最近购买时间
-- 只统计完成的订单(status=3)
-- 按消费总额降序
-- 限制前50名
```

### 5.3 每日订单统计
```sql
-- 统计每天的订单情况
-- 显示：日期、订单数、订单总额、平均订单金额
-- 按日期倒序
-- 只统计最近30天
```

### 5.4 分类销售占比
```sql
-- 统计各分类的销售情况
-- 显示：一级分类、销售额、占比(%)
-- 计算占比：分类销售额 / 总销售额 * 100
-- 按销售额降序
```

---

## 6. 时间维度分组

### 6.1 按小时统计
```sql
-- 统计一天中各小时的下单情况
-- 提取小时：HOUR(created_at)
-- 显示：小时、订单数
-- 按小时排序
```

### 6.2 按星期统计
```sql
-- 统计每周各天的订单量
-- DAYOFWEEK(created_at): 1=周日, 7=周六
-- 显示：星期、订单数、订单总额
-- 找出订单量最多的一天
```

### 6.3 按季度统计
```sql
-- 统计各季度的销售情况
-- QUARTER(created_at)
-- 显示：年份、季度、订单数、销售总额
-- 按年份和季度排序
```

---

## 7. WITH ROLLUP 小计

### 7.1 分类小计
```sql
-- 统计各分类的商品数量，包含总计
-- 使用 WITH ROLLUP
-- 显示：分类名称、商品数量
-- NULL 表示总计行
```

### 7.2 多维度汇总
```sql
-- 按状态和支付方式统计订单
-- 显示：订单状态、支付方式、订单数、订单金额
-- 使用 WITH ROLLUP 生成小计和总计
```

---

## 8. 条件聚合

### 8.1 使用 CASE 进行条件统计
```sql
-- 统计每个用户在不同价格区间的购买次数
-- 价格区间：<100, 100-500, >500
-- 显示：用户ID、低价订单数、中价订单数、高价订单数
-- 使用 SUM(CASE WHEN ... THEN 1 ELSE 0 END)
```

### 8.2 状态分布统计
```sql
-- 统计每天各订单状态的分布
-- 显示：日期、待支付数、已支付数、已发货数、已完成数、已取消数
-- 使用多个 COUNT(CASE ...)
-- 最近7天
```

---

## 9. 去重统计

### 9.1 DISTINCT 配合 COUNT
```sql
-- 统计每个商品被多少不同用户购买过
-- 显示：商品名称、购买用户数(去重)、购买总次数
-- 对比 COUNT(DISTINCT user_id) 和 COUNT(*)
-- 按用户数降序，限制前30
```

### 9.2 多维度去重
```sql
-- 统计用户的活跃度
-- 显示：用户ID、下单天数(去重)、购买商品种类数(去重)、总订单数
-- 按下单天数降序
```

---

## 10. 综合练习

### 10.1 RFM 分析（Recency, Frequency, Monetary）
```sql
-- 用户价值分析
-- R: 最近一次购买距今天数（越小越好）
-- F: 购买频次（越多越好）
-- M: 购买金额（越高越好）
-- 显示：用户ID、用户名、最近购买天数、购买次数、消费总额
-- 只统计完成的订单
-- 按消费总额降序，限制前100
```

### 10.2 商品复购率分析
```sql
-- 分析哪些商品的复购率高
-- 显示：商品名称、购买总次数、购买用户数、复购率(购买次数/用户数)
-- 复购率 > 1 说明有用户重复购买
-- 条件：购买用户数 >= 5
-- 按复购率降序
```

### 10.3 月度增长分析
```sql
-- 统计每月订单增长情况
-- 显示：年月、订单数、订单金额、环比增长率
-- 提示：可以使用子查询或窗口函数
-- 按月份排序
```

### 10.4 用户分层统计
```sql
-- 按消费金额对用户分层
-- 分层规则：
--   >= 10000: VIP
--   5000-9999: 高价值
--   1000-4999: 中等
--   < 1000: 普通
-- 显示：用户等级、用户数量、订单总数、消费总额
-- 使用 CASE 表达式
```

### 10.5 购物车转化分析
```sql
-- 分析购物车到订单的转化
-- 显示：用户ID、购物车商品数、已下单商品数、转化率
-- 转化率 = 已下单商品数 / 购物车商品数
-- 提示：需要关联 cart_items 和 order_items
-- 只显示有购物车的用户
```

---

## 学习检查点

完成所有练习后，你应该能够：
- [ ] 熟练使用各种聚合函数
- [ ] 理解 GROUP BY 的执行逻辑
- [ ] 区分 WHERE 和 HAVING 的使用场景
- [ ] 使用 GROUP_CONCAT 合并字符串
- [ ] 按不同时间维度进行统计
- [ ] 使用 CASE 进行条件聚合
- [ ] 编写复杂的数据分析SQL

**下一步**: 完成后查看 `solutions/03-聚合分组.md` 对照答案，然后进入第四阶段学习。
