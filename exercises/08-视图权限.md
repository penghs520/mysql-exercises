# 第八阶段：视图与权限练习

## 练习说明
- 视图提供数据抽象和安全性
- 权限管理保护数据安全
- 理解视图和权限的使用场景

---

## 1. 视图基础

### 1.1 创建简单视图
```sql
-- 创建用户订单统计视图
CREATE VIEW v_user_order_stats AS
SELECT
  u.id,
  u.username,
  u.email,
  COUNT(o.id) as order_count,
  IFNULL(SUM(o.pay_amount), 0) as total_amount
FROM users u
LEFT JOIN orders o ON u.id = o.user_id AND o.status = 3
GROUP BY u.id, u.username, u.email;

-- 查询视图
SELECT * FROM v_user_order_stats
WHERE order_count > 0
ORDER BY total_amount DESC
LIMIT 10;

-- 删除视图
DROP VIEW IF EXISTS v_user_order_stats;
```

### 1.2 创建复杂视图
```sql
-- 商品销售汇总视图
CREATE VIEW v_product_sales_summary AS
SELECT
  p.id,
  p.name as product_name,
  c.name as category_name,
  p.price,
  p.stock,
  IFNULL(SUM(oi.quantity), 0) as total_sold,
  IFNULL(SUM(oi.total_amount), 0) as total_revenue,
  COUNT(DISTINCT o.user_id) as unique_buyers,
  AVG(pr.rating) as avg_rating,
  COUNT(pr.id) as review_count
FROM products p
LEFT JOIN categories c ON p.category_id = c.id
LEFT JOIN order_items oi ON p.id = oi.product_id
LEFT JOIN orders o ON oi.order_id = o.id AND o.status = 3
LEFT JOIN product_reviews pr ON p.id = pr.product_id
GROUP BY p.id, p.name, c.name, p.price, p.stock;

-- 使用视图
SELECT *
FROM v_product_sales_summary
WHERE total_sold > 0
ORDER BY total_revenue DESC
LIMIT 20;

DROP VIEW IF EXISTS v_product_sales_summary;
```

### 1.3 视图上的视图
```sql
-- 基础视图：用户消费统计
CREATE VIEW v_user_spending AS
SELECT
  user_id,
  SUM(pay_amount) as total_spending
FROM orders
WHERE status = 3
GROUP BY user_id;

-- 基于视图的视图：VIP用户
CREATE VIEW v_vip_users AS
SELECT
  u.id,
  u.username,
  u.email,
  s.total_spending
FROM users u
JOIN v_user_spending s ON u.id = s.user_id
WHERE s.total_spending >= 5000;

-- 查询
SELECT * FROM v_vip_users LIMIT 10;

-- 清理
DROP VIEW IF EXISTS v_vip_users;
DROP VIEW IF EXISTS v_user_spending;
```

---

## 2. 视图操作

### 2.1 查看视图定义
```sql
-- 创建测试视图
CREATE VIEW v_active_products AS
SELECT id, name, price, stock
FROM products
WHERE status = 1;

-- 查看视图定义
SHOW CREATE VIEW v_active_products;

-- 查看所有视图
SELECT TABLE_NAME, VIEW_DEFINITION
FROM information_schema.VIEWS
WHERE TABLE_SCHEMA = 'study_db';

DROP VIEW IF EXISTS v_active_products;
```

### 2.2 修改视图
```sql
-- 创建视图
CREATE VIEW v_order_summary AS
SELECT order_no, user_id, total_amount
FROM orders;

-- 方法1：CREATE OR REPLACE
CREATE OR REPLACE VIEW v_order_summary AS
SELECT order_no, user_id, total_amount, status, created_at
FROM orders;

-- 方法2：ALTER VIEW
ALTER VIEW v_order_summary AS
SELECT order_no, user_id, total_amount, status, created_at, payment_time
FROM orders;

DROP VIEW IF EXISTS v_order_summary;
```

---

## 3. 可更新视图

### 3.1 简单可更新视图
```sql
-- 创建可更新视图
CREATE VIEW v_product_info AS
SELECT id, name, price, stock, status
FROM products;

-- 测试更新（谨慎操作，会修改实际数据）
-- UPDATE v_product_info SET stock = stock + 10 WHERE id = 1;

-- 测试插入
-- INSERT INTO v_product_info (name, price, stock, status)
-- VALUES ('测试商品', 99.00, 100, 1);

-- 测试删除
-- DELETE FROM v_product_info WHERE name = '测试商品';

DROP VIEW IF EXISTS v_product_info;
```

### 3.2 WITH CHECK OPTION
```sql
-- 创建带检查选项的视图
CREATE VIEW v_expensive_products AS
SELECT id, name, price, stock
FROM products
WHERE price > 500
WITH CHECK OPTION;

-- 可以查询
SELECT * FROM v_expensive_products LIMIT 10;

-- 更新价格>500的商品（成功）
-- UPDATE v_expensive_products SET stock = stock + 1 WHERE id = 1;

-- 更新价格到<=500（失败，违反检查条件）
-- UPDATE v_expensive_products SET price = 400 WHERE id = 1;

DROP VIEW IF EXISTS v_expensive_products;
```

### 3.3 不可更新的视图
```sql
-- 以下视图不可更新：
-- 1. 包含聚合函数
CREATE VIEW v_category_stats AS
SELECT category_id, COUNT(*) as product_count, AVG(price) as avg_price
FROM products
GROUP BY category_id;

-- 2. 包含DISTINCT
CREATE VIEW v_distinct_prices AS
SELECT DISTINCT price FROM products;

-- 3. 包含UNION
CREATE VIEW v_all_names AS
SELECT username as name FROM users
UNION
SELECT name FROM products;

-- 4. 包含子查询
CREATE VIEW v_above_avg_price AS
SELECT * FROM products
WHERE price > (SELECT AVG(price) FROM products);

-- 清理
DROP VIEW IF EXISTS v_category_stats;
DROP VIEW IF EXISTS v_distinct_prices;
DROP VIEW IF EXISTS v_all_names;
DROP VIEW IF EXISTS v_above_avg_price;
```

---

## 4. 视图应用场景

### 4.1 简化复杂查询
```sql
-- 订单详情视图（简化多表连接）
CREATE VIEW v_order_details AS
SELECT
  o.id as order_id,
  o.order_no,
  o.created_at as order_date,
  u.username,
  u.email,
  o.total_amount,
  o.status,
  CASE o.status
    WHEN 0 THEN '待支付'
    WHEN 1 THEN '已支付'
    WHEN 2 THEN '已发货'
    WHEN 3 THEN '已完成'
    WHEN 4 THEN '已取消'
  END as status_name,
  o.receiver_name,
  o.receiver_phone,
  o.receiver_address
FROM orders o
JOIN users u ON o.user_id = u.id;

-- 使用视图（比写完整JOIN简单）
SELECT * FROM v_order_details
WHERE status = 1
ORDER BY order_date DESC
LIMIT 20;

DROP VIEW IF EXISTS v_order_details;
```

### 4.2 数据安全和隐私
```sql
-- 创建隐藏敏感信息的视图
CREATE VIEW v_user_public_info AS
SELECT
  id,
  username,
  LEFT(email, 3) as email_prefix,
  CONCAT(SUBSTRING(phone, 1, 3), '****', SUBSTRING(phone, 8, 4)) as masked_phone,
  status,
  created_at
FROM users;

-- 只暴露公开信息
SELECT * FROM v_user_public_info LIMIT 10;

DROP VIEW IF EXISTS v_user_public_info;
```

### 4.3 逻辑数据独立性
```sql
-- 即使表结构改变，视图可以保持接口稳定
-- 假设需要拆分products表，可以通过视图保持兼容性
CREATE VIEW v_products AS
SELECT
  id,
  name,
  price,
  stock,
  status
FROM products;

-- 应用代码使用视图而不是直接访问表
SELECT * FROM v_products WHERE status = 1 LIMIT 10;

DROP VIEW IF EXISTS v_products;
```

---

## 5. 用户管理

### 5.1 创建用户
```sql
-- 创建本地用户
CREATE USER 'readonly_user'@'localhost' IDENTIFIED BY 'password123';

-- 创建可以从任何主机连接的用户
CREATE USER 'app_user'@'%' IDENTIFIED BY 'app_password';

-- 查看用户
SELECT user, host FROM mysql.user WHERE user LIKE '%user%';
```

### 5.2 删除用户
```sql
-- 删除用户
DROP USER IF EXISTS 'readonly_user'@'localhost';
DROP USER IF EXISTS 'app_user'@'%';
```

### 5.3 修改密码
```sql
-- 修改用户密码
ALTER USER 'app_user'@'%' IDENTIFIED BY 'new_password';

-- 修改当前用户密码（MySQL 8.0+）
ALTER USER USER() IDENTIFIED BY 'new_password';

-- 或使用 SET PASSWORD（MySQL 8.0+）
SET PASSWORD = 'new_password';
```

---

## 6. 权限管理

### 6.1 授予权限
```sql
-- 创建只读用户
CREATE USER 'reader'@'%' IDENTIFIED BY 'reader123';

-- 授予SELECT权限
GRANT SELECT ON study_db.* TO 'reader'@'%';

-- 授予特定表的权限
GRANT SELECT, INSERT ON study_db.orders TO 'app_user'@'%';

-- 授予所有权限
GRANT ALL PRIVILEGES ON study_db.* TO 'admin_user'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 6.2 查看权限
```sql
-- 查看用户权限
SHOW GRANTS FOR 'reader'@'%';

-- 查看当前用户权限
SHOW GRANTS FOR CURRENT_USER;
```

### 6.3 回收权限
```sql
-- 回收权限
REVOKE INSERT ON study_db.orders FROM 'app_user'@'%';

-- 回收所有权限
REVOKE ALL PRIVILEGES ON study_db.* FROM 'app_user'@'%';

-- 刷新
FLUSH PRIVILEGES;
```

### 6.4 权限级别
```sql
-- 全局权限
GRANT SELECT ON *.* TO 'global_reader'@'%';

-- 数据库级权限
GRANT ALL ON study_db.* TO 'db_admin'@'%';

-- 表级权限
GRANT SELECT, UPDATE ON study_db.products TO 'product_manager'@'%';

-- 列级权限
GRANT SELECT (id, username, email) ON study_db.users TO 'limited_user'@'%';

-- 存储过程权限
GRANT EXECUTE ON PROCEDURE study_db.GetUserOrderCount TO 'app_user'@'%';
```

---

## 7. 角色管理（MySQL 8.0+）

### 7.1 创建角色
```sql
-- 创建角色
CREATE ROLE 'app_reader', 'app_writer', 'app_admin';

-- 授予角色权限
GRANT SELECT ON study_db.* TO 'app_reader';
GRANT SELECT, INSERT, UPDATE ON study_db.* TO 'app_writer';
GRANT ALL ON study_db.* TO 'app_admin';
```

### 7.2 分配角色
```sql
-- 创建用户并分配角色
CREATE USER 'user1'@'%' IDENTIFIED BY 'password';
GRANT 'app_reader' TO 'user1'@'%';

-- 设置默认角色
SET DEFAULT ROLE 'app_reader' TO 'user1'@'%';

-- 激活角色
SET ROLE 'app_reader';
```

### 7.3 角色层级
```sql
-- 角色可以包含其他角色
GRANT 'app_reader' TO 'app_writer';
GRANT 'app_writer' TO 'app_admin';

-- 查看角色
SHOW GRANTS FOR 'app_admin';
```

---

## 8. 实战场景

### 8.1 只读账号配置
```sql
-- 1. 创建只读用户
CREATE USER 'report_user'@'%' IDENTIFIED BY 'report_pwd';

-- 2. 授予只读权限
GRANT SELECT ON study_db.* TO 'report_user'@'%';

-- 3. 创建报表视图
CREATE VIEW v_daily_sales_report AS
SELECT
  DATE(created_at) as sale_date,
  COUNT(*) as order_count,
  SUM(pay_amount) as total_amount,
  AVG(pay_amount) as avg_amount
FROM orders
WHERE status = 3
GROUP BY DATE(created_at);

-- 4. 只允许访问视图
-- REVOKE SELECT ON study_db.* FROM 'report_user'@'%';
-- GRANT SELECT ON study_db.v_daily_sales_report TO 'report_user'@'%';

-- 清理
DROP VIEW IF EXISTS v_daily_sales_report;
-- DROP USER 'report_user'@'%';
```

### 8.2 应用账号配置
```sql
-- 创建应用用户
CREATE USER 'ecommerce_app'@'%' IDENTIFIED BY 'app_secure_pwd';

-- 授予必要的权限
GRANT SELECT, INSERT, UPDATE ON study_db.users TO 'ecommerce_app'@'%';
GRANT SELECT, INSERT, UPDATE ON study_db.orders TO 'ecommerce_app'@'%';
GRANT SELECT, INSERT, UPDATE ON study_db.order_items TO 'ecommerce_app'@'%';
GRANT SELECT, UPDATE ON study_db.products TO 'ecommerce_app'@'%';

-- 禁止DELETE（防止误删）
-- 禁止访问敏感表
-- REVOKE ALL ON study_db.payments FROM 'ecommerce_app'@'%';

-- 清理
-- DROP USER 'ecommerce_app'@'%';
```

### 8.3 数据脱敏视图
```sql
-- 创建脱敏视图供外部系统访问
CREATE VIEW v_user_for_marketing AS
SELECT
  id,
  CONCAT(LEFT(username, 1), '***') as username,
  CONCAT(LEFT(email, 3), '***@***', SUBSTRING_INDEX(email, '@', -1)) as email,
  CONCAT(SUBSTRING(phone, 1, 3), '****', SUBSTRING(phone, 8)) as phone,
  YEAR(created_at) as register_year,
  QUARTER(created_at) as register_quarter
FROM users
WHERE status = 1;

SELECT * FROM v_user_for_marketing LIMIT 10;

DROP VIEW IF EXISTS v_user_for_marketing;
```

---

## 9. 安全最佳实践

### 9.1 最小权限原则
```sql
-- 不要授予不必要的权限
-- 错误示例：
-- GRANT ALL ON *.* TO 'app_user'@'%';

-- 正确示例：只授予需要的权限
-- GRANT SELECT, INSERT, UPDATE ON specific_db.specific_table TO 'app_user'@'%';
```

### 9.2 使用强密码
```sql
-- MySQL 8.0+: 查看密码策略组件
SHOW VARIABLES LIKE 'validate_password%';

-- 设置密码策略（需要先安装validate_password组件）
-- INSTALL COMPONENT 'file://component_validate_password';
-- SET GLOBAL validate_password.policy = STRONG;
-- SET GLOBAL validate_password.length = 8;

-- 创建用户时使用强密码
-- CREATE USER 'secure_user'@'%' IDENTIFIED BY 'StrongP@ssw0rd123!';
```

### 9.3 定期审计
```sql
-- 查看所有用户
SELECT user, host, account_locked FROM mysql.user;

-- 查看权限分配
SELECT * FROM mysql.db WHERE Db = 'study_db';

-- 查看表权限
SELECT * FROM mysql.tables_priv WHERE Db = 'study_db';
```

---

## 10. 综合练习

### 10.1 设计权限方案
```sql
-- 为电商系统设计权限方案：
-- 1. 管理员：全部权限
-- 2. 运营人员：查看和修改订单、商品
-- 3. 财务人员：查看订单、支付记录（只读）
-- 4. 客服人员：查看用户、订单信息（只读）
-- 5. 数据分析师：只能访问统计视图

-- 实现上述方案
```

### 10.2 创建业务视图系统
```sql
-- 创建一套完整的业务视图：
-- 1. 用户统计视图
-- 2. 商品销售视图
-- 3. 订单分析视图
-- 4. 财务报表视图
-- 5. 实时大屏视图

-- 要求：
-- - 性能优化
-- - 数据脱敏
-- - 访问控制
```

---

## 学习检查点

完成所有练习后，你应该能够：
- [ ] 创建和管理视图
- [ ] 理解可更新视图的限制
- [ ] 使用视图简化复杂查询
- [ ] 通过视图实现数据安全
- [ ] 创建和管理用户
- [ ] 授予和回收权限
- [ ] 使用角色管理权限（MySQL 8.0+）
- [ ] 设计安全的权限方案

**下一步**: 完成后查看 `solutions/08-视图权限.md` 对照答案，然后进入第九阶段学习。
