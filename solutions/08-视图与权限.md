# 第八阶段：视图与权限完整答案

## 核心知识点

### 1. 视图 (View) 基础

**什么是视图?**
- 虚拟表,基于 SQL 查询结果
- 不存储数据,只存储查询定义
- 可以像表一样查询

**视图的作用:**
1. **简化查询**: 封装复杂 JOIN
2. **数据安全**: 隐藏敏感字段
3. **逻辑独立**: 表结构变化不影响应用
4. **权限控制**: 限制用户访问范围

**视图类型:**
- **简单视图**: 基于单表,可更新
- **复杂视图**: 包含 JOIN/聚合函数,通常只读
- **物化视图**: MySQL 不支持(Oracle/PostgreSQL 有)

### 2. 视图的限制

**不可更新的视图:**
- 包含聚合函数 (SUM/COUNT/AVG/MAX/MIN)
- 包含 GROUP BY/HAVING
- 包含 DISTINCT
- 包含 UNION
- 包含子查询(某些情况)

**性能考虑:**
- 视图不会提升性能,只是逻辑抽象
- 每次查询视图都会执行底层 SQL
- 复杂视图可能影响性能

### 3. 权限管理体系

**权限级别 (从高到低):**
1. **全局权限**: `*.*` 所有数据库
2. **数据库权限**: `db_name.*` 指定数据库
3. **表权限**: `db_name.table_name` 指定表
4. **列权限**: 指定列(很少用)

**常用权限类型:**
- **数据权限**: SELECT, INSERT, UPDATE, DELETE
- **结构权限**: CREATE, ALTER, DROP, INDEX
- **管理权限**: CREATE USER, GRANT, SUPER
- **其他**: EXECUTE (存储过程), TRIGGER

### 4. 角色 (MySQL 8.0+)

**角色的优势:**
- 简化权限管理
- 批量授权
- 权限复用

**基本操作:**
```sql
-- 创建角色
CREATE ROLE 'role_name';

-- 授予角色权限
GRANT SELECT ON db.* TO 'role_name';

-- 将角色分配给用户
GRANT 'role_name' TO 'user'@'host';

-- 激活角色
SET DEFAULT ROLE 'role_name' TO 'user'@'host';
```

---

## 1. 创建常用业务视图

### 1.1 订单汇总视图

```sql
CREATE VIEW v_order_summary AS
SELECT
  o.id,
  o.order_no,
  o.created_at,
  u.username,
  u.email,
  o.total_amount,
  CASE o.status
    WHEN 0 THEN '待支付'
    WHEN 1 THEN '已支付'
    WHEN 2 THEN '已发货'
    WHEN 3 THEN '已完成'
    WHEN 4 THEN '已取消'
  END as status_name,
  o.receiver_name,
  o.receiver_phone,
  COUNT(oi.id) as item_count
FROM orders o
JOIN users u ON o.user_id = u.id
LEFT JOIN order_items oi ON o.id = oi.order_id
GROUP BY o.id, o.order_no, o.created_at, u.username, u.email,
         o.total_amount, o.status, o.receiver_name, o.receiver_phone;

-- 使用视图
SELECT * FROM v_order_summary
WHERE status_name = '已完成'
ORDER BY created_at DESC
LIMIT 20;
```

**知识点:**
- 封装复杂 JOIN 和 CASE 表达式
- 将状态码转换为可读文本
- 聚合订单明细数量
- 应用层无需关心底层表结构

### 1.2 商品销售统计视图

```sql
CREATE VIEW v_product_sales AS
SELECT
  p.id,
  p.name,
  p.price,
  p.stock,
  IFNULL(SUM(oi.quantity), 0) as total_sold,
  IFNULL(SUM(oi.total_amount), 0) as total_revenue,
  IFNULL(AVG(pr.rating), 0) as avg_rating,
  COUNT(DISTINCT pr.id) as review_count
FROM products p
LEFT JOIN order_items oi ON p.id = oi.product_id
LEFT JOIN product_reviews pr ON p.id = pr.product_id
WHERE p.status = 1
GROUP BY p.id, p.name, p.price, p.stock;

-- 查询热销商品
SELECT * FROM v_product_sales
WHERE total_sold > 0
ORDER BY total_revenue DESC
LIMIT 20;
```

**知识点:**
- 多表关联统计
- `IFNULL` 处理 NULL 值
- 聚合销量、评价等指标
- 用于数据分析和报表

### 1.3 用户消费统计视图

```sql
CREATE VIEW v_user_consumption AS
SELECT
  u.id,
  u.username,
  u.email,
  COUNT(DISTINCT o.id) as order_count,
  IFNULL(SUM(o.pay_amount), 0) as total_spending,
  IFNULL(AVG(o.pay_amount), 0) as avg_order_amount,
  MAX(o.created_at) as last_order_time,
  DATEDIFF(NOW(), MAX(o.created_at)) as days_since_last_order
FROM users u
LEFT JOIN orders o ON u.id = o.user_id AND o.status = 3
GROUP BY u.id, u.username, u.email;

-- 查询活跃用户
SELECT * FROM v_user_consumption
WHERE days_since_last_order <= 30
ORDER BY total_spending DESC;
```

---

## 2. 数据脱敏视图

### 2.1 用户信息脱敏

```sql
CREATE VIEW v_user_masked AS
SELECT
  id,
  username,
  -- 邮箱脱敏: a***@example.com
  CONCAT(
    LEFT(email, 1),
    '***@',
    SUBSTRING_INDEX(email, '@', -1)
  ) as masked_email,
  -- 手机脱敏: 138****5678
  CONCAT(
    SUBSTRING(phone, 1, 3),
    '****',
    SUBSTRING(phone, 8, 4)
  ) as masked_phone,
  status,
  created_at
FROM users;

-- 查询
SELECT * FROM v_user_masked LIMIT 10;
```

**知识点:**
- `LEFT(str, n)`: 取左边 n 个字符
- `SUBSTRING_INDEX(str, delim, count)`: 按分隔符拆分
- `CONCAT`: 字符串拼接
- 用于给非管理员用户展示

### 2.2 订单敏感信息脱敏

```sql
CREATE VIEW v_order_public AS
SELECT
  id,
  order_no,
  -- 隐藏用户ID,只显示前3位
  CONCAT(LEFT(user_id, 3), '***') as masked_user_id,
  total_amount,
  status,
  -- 隐藏详细地址,只显示省市
  CONCAT(
    SUBSTRING_INDEX(receiver_address, '省', 1), '省 ',
    SUBSTRING_INDEX(SUBSTRING_INDEX(receiver_address, '市', 1), '省', -1), '市'
  ) as masked_address,
  created_at
FROM orders;
```

---

## 3. 权限配置实战

### 3.1 场景1: 只读分析账号

```sql
-- 1. 创建只读用户
CREATE USER 'analyst'@'%' IDENTIFIED BY 'analyst_password_123';

-- 2. 只授予视图查询权限
GRANT SELECT ON study_db.v_order_summary TO 'analyst'@'%';
GRANT SELECT ON study_db.v_product_sales TO 'analyst'@'%';
GRANT SELECT ON study_db.v_user_masked TO 'analyst'@'%';

-- 3. 禁止访问原表 (默认没权限,无需额外操作)

-- 4. 刷新权限
FLUSH PRIVILEGES;

-- 验证权限
SHOW GRANTS FOR 'analyst'@'%';
```

**测试 (需切换到 analyst 用户):**
```sql
-- ✅ 可以访问视图
SELECT * FROM v_order_summary LIMIT 10;

-- ❌ 无法访问原表
SELECT * FROM orders LIMIT 10;
-- ERROR 1142: SELECT command denied to user 'analyst'@'%' for table 'orders'
```

### 3.2 场景2: 应用程序账号

```sql
-- 1. 创建应用用户
CREATE USER 'app_service'@'192.168.1.%' IDENTIFIED BY 'app_secure_pwd_456';

-- 2. 授予必要的表权限
GRANT SELECT, INSERT, UPDATE ON study_db.orders TO 'app_service'@'192.168.1.%';
GRANT SELECT, INSERT, UPDATE ON study_db.order_items TO 'app_service'@'192.168.1.%';
GRANT SELECT, UPDATE ON study_db.products TO 'app_service'@'192.168.1.%';
GRANT SELECT ON study_db.users TO 'app_service'@'192.168.1.%';
GRANT SELECT ON study_db.user_addresses TO 'app_service'@'192.168.1.%';

-- 3. 授予存储过程执行权限
GRANT EXECUTE ON PROCEDURE study_db.CreateOrderComplete TO 'app_service'@'192.168.1.%';
GRANT EXECUTE ON PROCEDURE study_db.DeductStockSafe TO 'app_service'@'192.168.1.%';

-- 4. 禁止 DELETE 和 DROP (默认没有权限)

FLUSH PRIVILEGES;
```

**知识点:**
- `'user'@'192.168.1.%'`: 限制来源IP段
- 只授予最小必要权限
- 禁止 DELETE,防止误删数据
- 可以执行存储过程,但看不到源码

### 3.3 场景3: 使用角色管理权限 (MySQL 8.0+)

```sql
-- 1. 创建角色
CREATE ROLE 'role_read_only';
CREATE ROLE 'role_order_manage';
CREATE ROLE 'role_admin';

-- 2. 为角色分配权限

-- 只读角色: 可以查看所有表
GRANT SELECT ON study_db.* TO 'role_read_only';

-- 订单管理角色: 可以管理订单
GRANT SELECT, INSERT, UPDATE ON study_db.orders TO 'role_order_manage';
GRANT SELECT, INSERT, UPDATE ON study_db.order_items TO 'role_order_manage';
GRANT SELECT ON study_db.products TO 'role_order_manage';
GRANT SELECT ON study_db.users TO 'role_order_manage';
GRANT EXECUTE ON PROCEDURE study_db.CreateOrderComplete TO 'role_order_manage';

-- 管理员角色: 所有权限
GRANT ALL ON study_db.* TO 'role_admin';

-- 3. 创建用户并分配角色

-- 只读用户
CREATE USER 'readonly_user'@'%' IDENTIFIED BY 'pwd123';
GRANT 'role_read_only' TO 'readonly_user'@'%';
SET DEFAULT ROLE 'role_read_only' TO 'readonly_user'@'%';

-- 订单管理员
CREATE USER 'order_manager'@'%' IDENTIFIED BY 'pwd456';
GRANT 'role_order_manage' TO 'order_manager'@'%';
SET DEFAULT ROLE 'role_order_manage' TO 'order_manager'@'%';

-- 管理员
CREATE USER 'admin_user'@'%' IDENTIFIED BY 'admin_pwd_789';
GRANT 'role_admin' TO 'admin_user'@'%';
SET DEFAULT ROLE 'role_admin' TO 'admin_user'@'%';

FLUSH PRIVILEGES;
```

**知识点:**
- 角色是权限的集合
- 一个用户可以有多个角色
- `SET DEFAULT ROLE`: 登录时自动激活角色
- 角色修改后,用户权限自动更新

### 3.4 场景4: 开发环境临时账号

```sql
-- 创建临时开发账号,7天后自动过期
CREATE USER 'dev_temp'@'%' IDENTIFIED BY 'temp_pwd'
  PASSWORD EXPIRE INTERVAL 7 DAY;

-- 授予开发库权限
GRANT ALL ON dev_db.* TO 'dev_temp'@'%';

-- 禁止操作生产库
REVOKE ALL ON prod_db.* FROM 'dev_temp'@'%';

FLUSH PRIVILEGES;
```

---

## 4. 权限审计与管理

### 4.1 查看权限

```sql
-- 查看所有用户
SELECT user, host FROM mysql.user;

-- 查看用户权限
SHOW GRANTS FOR 'app_service'@'192.168.1.%';

-- 查看当前用户权限
SHOW GRANTS;

-- 查看角色权限
SHOW GRANTS FOR 'role_read_only';
```

### 4.2 回收权限

```sql
-- 回收特定权限
REVOKE INSERT, UPDATE ON study_db.orders FROM 'app_service'@'192.168.1.%';

-- 回收所有权限
REVOKE ALL PRIVILEGES ON study_db.* FROM 'app_service'@'192.168.1.%';

-- 回收角色
REVOKE 'role_admin' FROM 'admin_user'@'%';

FLUSH PRIVILEGES;
```

### 4.3 删除用户

```sql
-- 删除用户 (会自动回收所有权限)
DROP USER 'dev_temp'@'%';

-- 删除角色
DROP ROLE 'role_read_only';
```

---

## 关键学习点总结

### 1. 视图使用建议

**适用场景:**
- ✅ 简化复杂查询,提高可维护性
- ✅ 隐藏敏感字段,数据安全
- ✅ 提供统一数据接口
- ✅ 兼容性:表结构变化不影响应用

**注意事项:**
- ❌ 视图不会提升性能
- ❌ 避免视图套视图(影响可读性)
- ❌ 复杂视图可能难以优化
- ⚠️ 更新视图有限制

### 2. 权限管理原则

**最小权限原则:**
- 只授予完成工作所需的最小权限
- 不需要的权限一律不给
- 定期审计,回收不必要的权限

**分层管理:**
- 使用角色而不是直接授权
- 按职能划分角色
- 用户只分配角色,不单独授权

**安全加固:**
- 限制连接来源 IP (`'user'@'192.168.1.%'`)
- 使用强密码策略
- 定期更换密码
- 禁用 root 远程登录
- 删除匿名用户和测试库

### 3. 视图 vs 表

| 对比项 | 视图 | 表 |
|-------|-----|-----|
| 存储 | 只存储定义 | 存储数据 |
| 性能 | 每次查询执行 | 直接读取 |
| 更新 | 有限制 | 完全支持 |
| 空间 | 几乎不占 | 占用空间 |
| 用途 | 逻辑抽象 | 数据存储 |

---

## 实践建议

### 视图实践:
1. ✅ 为常用复杂查询创建视图
2. ✅ 给不同用户组创建脱敏视图
3. ✅ 视图命名规范: `v_` 前缀
4. ✅ 添加注释说明视图用途
5. ❌ 避免在视图中使用 `SELECT *`

### 权限实践:
1. ✅ 永远不要直接使用 root 账号
2. ✅ 为不同角色创建专用账号
3. ✅ 使用角色管理权限 (MySQL 8.0+)
4. ✅ 定期审计权限,清理无用账号
5. ✅ 记录权限变更日志

### 安全检查清单:
- [ ] root 账号是否禁止远程登录?
- [ ] 是否删除了匿名用户?
- [ ] 是否删除了 test 数据库?
- [ ] 应用账号是否限制了来源 IP?
- [ ] 应用账号是否有 DELETE/DROP 权限?
- [ ] 是否使用了强密码?
- [ ] 是否定期更换密码?

继续学习第九阶段性能优化!
